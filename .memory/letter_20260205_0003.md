# Letter to Myself (Session Handoff)

**Date:** 2026-02-05 14:45 CET

## 1. Executive Summary
* **Goal:** Migrate Aurus Voice Intelligence from desktop-only (Tauri + Next.js) to cross-platform mobile-ready architecture.
* **Current Status:** Completed Phases 1, 2, 3, and 4 infrastructure. All builds passing. Ready for Phase 5 (sync strategy) and Phase 6 (testing).

## 2. The "Done" List (Context Anchor)

### Phase 1: Foundation ✅
* Platform abstraction layer (`src-tauri/src/platform/`)
* Secrets module with SecureStorage trait
* macOS/iOS Keychain, Windows Credential Manager, Linux Secret Service, Android Keystore
* Mobile capabilities JSON and setup documentation
* Frontend platform detection hook (`usePlatform.ts`)

### Phase 2: Security Layer ✅
* Migrated secrets.rs from plaintext JSON to OS keychain
* Fixed Keychain error handling patterns
* All Keychain unit tests passing

### Phase 3: Audio Pipeline Mobile Adaptation ✅
* Created `src-tauri/src/platform/audio/mod.rs` - AudioCapture trait
* Created `src-tauri/src/platform/audio/desktop.rs` - CPAL implementation
* Created `src-tauri/src/platform/audio/mobile.rs` - Mobile stub (NotSupported)
* Created `app/hooks/useWebAudioCapture.ts` - Web Audio API for mobile
* Existing `send_audio_to_deepgram` command serves as the bridge

### Phase 4: On-Device AI Infrastructure ✅
* `app/workers/ai-worker.ts` - Web Worker for Transformers.js inference
* `app/hooks/useLocalAI.ts` - React hook for transcribe/summarize/analyze
* Configured for Whisper tiny, DistilBART, and DistilBERT models

## 3. The "Pain" Log (CRITICAL)

* **Tried:** Callback type `Box<dyn Fn(AudioChunk) + Send>` in AudioCapture trait
* **Failed:** "cannot be shared between threads safely" error with Arc<Box<dyn Fn>>
* **Workaround:** Changed to `Box<dyn Fn(AudioChunk) + Send + Sync>` for thread safety
* *Note:* When wrapping callbacks in Arc for multi-threaded use, require Sync trait

* **Tried:** Using same `is_recording` Arc in both inner closure and outer while loop
* **Failed:** "borrow of moved value" - Arc moved into inner closure
* **Workaround:** Clone `is_recording` to `is_recording_inner` before spawning thread
* *Note:* Always clone Arc before moving into closures if you need it outside too

## 4. Active Variable State
* Working directory: `/Users/oliverbaer/Projects/aurus-voiceintelligence`
* Build status: `pnpm build` passes, `cargo check` passes
* Test status: 33/33 frontend tests, 7/7 Rust tests (3 new audio tests)
* All npm dependencies installed

## 5. Mobile Audio Architecture

```
┌──────────────────────────────────────────────────────────────┐
│ Desktop                                                       │
│ ┌─────────────┐    ┌────────────┐    ┌───────────────────┐   │
│ │ CPAL Input  │ -> │ audio.rs   │ -> │ transcription.rs  │   │
│ │ (native)    │    │ (direct)   │    │ (Deepgram WS)     │   │
│ └─────────────┘    └────────────┘    └───────────────────┘   │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ Mobile (iOS/Android)                                          │
│ ┌─────────────────────┐     ┌────────────────────────────┐   │
│ │ useWebAudioCapture  │ --> │ invoke send_audio_to_deepgram│  │
│ │ (Web Audio API)     │     │ (Tauri Command)             │   │
│ └─────────────────────┘     └─────────────┬──────────────┘   │
└──────────────────────────────────────────|────────────────────┘
                                           ↓
┌──────────────────────────────────────────────────────────────┐
│ Rust (transcription.rs)                                       │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ Deepgram WebSocket streaming (shared by both platforms)  │   │
│ └─────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

## 6. Immediate Next Steps
1. [ ] Phase 5: Design Yjs + WebRTC sync architecture for Desktop ↔ Mobile
2. [ ] Phase 6: Add mobile-specific unit tests for platform detection
3. [ ] Install iOS SDK and run `pnpm tauri ios init` with Team ID
4. [ ] Install Android SDK and run `pnpm tauri android init`
5. [ ] Create GitHub Actions workflow for mobile CI/CD
6. [ ] Test Transformers.js worker initialization in browser dev mode
7. [ ] Test useWebAudioCapture in mobile simulator

## 7. Files Modified This Session
```
src-tauri/src/platform/audio/mod.rs      (NEW)
src-tauri/src/platform/audio/desktop.rs  (NEW)
src-tauri/src/platform/audio/mobile.rs   (NEW)
src-tauri/src/platform/mod.rs            (MODIFIED - added audio module)
app/hooks/useWebAudioCapture.ts          (NEW)
```

## 8. Test Commands
```bash
# All Rust tests
cargo test

# Audio module tests specifically
cargo test platform::audio

# Frontend tests
pnpm test -- --run

# Full build check
cargo check && pnpm build
```
