# Letter to Myself (Session Handoff)

**Date:** 2026-02-05 09:15 CET

## 1. Executive Summary
* **Goal:** Migrate Aurus Voice Intelligence from desktop-only to cross-platform (iOS/Android) while maintaining desktop builds and implementing security improvements.
* **Current Status:** Completed Phase 1 (Foundation), Phase 2 (Security Layer), and started Phase 4 (On-Device AI). Audio pipeline (Phase 3) blocked pending mobile SDK setup.

## 2. The "Done" List (Context Anchor)

### Phase 1: Foundation
* Created `src-tauri/src/platform/` abstraction layer with `SecureStorage` trait
* Implemented Keychain integration for macOS/iOS (`platform/secrets/apple.rs`)
* Implemented Windows Credential Manager (`platform/secrets/windows.rs`)
* Implemented Linux Secret Service (`platform/secrets/linux.rs`)
* Implemented Android Keystore stub (`platform/secrets/android.rs`)
* Created `src-tauri/capabilities/mobile.json` for mobile permissions
* Created `docs/MOBILE_SETUP.md` setup guide
* Added `@tauri-apps/plugin-os` for platform detection
* Created `app/hooks/usePlatform.ts` for frontend platform detection
* Updated `app/page.tsx` with conditional desktop-only UI rendering
* iOS/Android init deferred (requires Apple Team ID + Android SDK)

### Phase 2: Security Layer
* Rewrote `src-tauri/src/secrets.rs` to use platform abstraction
* Fixed Keychain error handling ("could not be found" pattern)
* All Keychain unit tests passing (2/2)
* Old insecure `.api_keys` file still exists at `~/Library/Application Support/voice-intelligence-hub/.api_keys` - users need manual migration

### Phase 4: On-Device AI (Started)
* Created `app/workers/ai-worker.ts` - Web Worker for Transformers.js inference
* Created `app/hooks/useLocalAI.ts` - React hook for on-device AI
* Added `@xenova/transformers` dependency
* Configured for Int4 quantization and WebGPU acceleration

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Separating Tauri dependency with target-specific `macos-private-api` feature
* **Failed:** Tauri build script requires features to match `tauri.conf.json`
* **Workaround:** Keep feature in main dependency (ignored on other platforms)
* *Note:* Don't try to conditionally include Tauri features per-platform

* **Tried:** Matching "not found" error from Keychain
* **Failed:** Error message was "The specified item could not be found in the keychain." - didn't match "not found" pattern
* **Workaround:** Added "could not be found" to pattern matching in `apple.rs`
* *Note:* macOS Security.framework error messages vary - use broad pattern matching

* **Tried:** Running `pnpm tauri ios init`
* **Failed:** Requires Apple Development Team ID
* **Workaround:** Skipped for now, documented in `docs/MOBILE_SETUP.md`

* **Tried:** Running `pnpm tauri android init`
* **Failed:** Android SDK not installed
* **Workaround:** Skipped for now, documented setup requirements

## 4. Active Variable State
* Working directory: `/Users/oliverbaer/Projects/aurus-voiceintelligence`
* Rust crate root: `src-tauri/`
* New npm dependencies need install: `@xenova/transformers`
* Build status: All tests pass (33/33 frontend, 2/2 Rust secrets)
* Next.js static export: Working

## 5. Immediate Next Steps
1. [ ] Run `pnpm install` to install @xenova/transformers
2. [ ] Test Transformers.js worker initialization in browser
3. [ ] Phase 3: Evaluate CPAL mobile alternatives or document limitation
4. [ ] Phase 5: Design Yjs + WebRTC sync strategy
5. [ ] Phase 6: Add mobile-specific tests
6. [ ] Set up CI/CD for mobile builds (after SDK setup)

## 6. Architecture Summary

```
src-tauri/src/
├── lib.rs                    # Entry point, plugin registration
├── platform/
│   └── secrets/
│       ├── mod.rs            # SecureStorage trait
│       ├── apple.rs          # macOS/iOS Keychain ✅
│       ├── windows.rs        # Windows Credential Manager ✅
│       ├── linux.rs          # Secret Service ✅
│       └── android.rs        # Android Keystore (stub) ✅
├── secrets.rs                # Tauri commands using platform abstraction ✅
├── audio.rs                  # Desktop-only (CPAL) ⚠️
├── tts.rs                    # Desktop-only (shell) ⚠️
├── transcription.rs          # Deepgram + Whisper (desktop) ✅
└── agents/                   # All HTTP-based (portable) ✅

app/
├── hooks/
│   ├── usePlatform.ts        # Platform detection ✅
│   └── useLocalAI.ts         # Transformers.js hook ✅
├── workers/
│   └── ai-worker.ts          # Web Worker for inference ✅
└── page.tsx                  # Conditional desktop UI ✅
```

## 7. Test Commands
```bash
# Frontend tests
pnpm test -- --run

# Rust tests (secrets)
cd src-tauri && cargo test platform::secrets

# Full build check
cd src-tauri && cargo check
pnpm build
```
